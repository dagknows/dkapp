networks:
  saaslocalnetwork:
    external: true

services:
  req-router:
    image: ${DK_REQ_ROUTER_IMAGE:-public.ecr.aws/n5k3t9x2/req_router}:${DK_REQ_ROUTER_TAG:-latest}
    networks:
      - saaslocalnetwork
    command: ["sh", "src/wait-for-it.sh"]
    volumes:
      - ./tls:/usr/src/app/tls
      - /etc/letsencrypt:/etc/letsencrypt
    depends_on:
      taskservice:
        condition: service_healthy
    environment:
      - APP_SECRET_KEY=${APP_SECRET_KEY}
      - COMMUNITY_URL=${COMMUNITY_URL}
      - COMPOSE_HTTP_TIMEOUT=300
      - CUSTOMER_AD_EMAIL_ATTR=${CUSTOMER_AD_EMAIL_ATTR}
      - CUSTOMER_AD_SEARCH_BASE_OU=${CUSTOMER_AD_SEARCH_BASE_OU}
      - CUSTOMER_AD_SERVER_URI=${CUSTOMER_AD_SERVER_URI}
      - CUSTOMER_AD_SERVICE_PASSWORD=${CUSTOMER_AD_SERVICE_PASSWORD}
      - CUSTOMER_AD_SERVICE_USERNAME=${CUSTOMER_AD_SERVICE_USERNAME}
      - CUSTOMER_AD_USERNAME_ATTR=${CUSTOMER_AD_USERNAME_ATTR}
      - CUSTOMER_AD_USE_TLS=${CUSTOMER_AD_USE_TLS}
      - DAGKNOWS_ELASTIC_URL=${DAGKNOWS_ELASTIC_URL}
      - DAGKNOWS_URL=${DAGKNOWS_URL}
      - DEFAULT_PAGE_SIZE=${DEFAULT_PAGE_SIZE}
      - ENFORCE_LOGIN=${ENFORCE_LOGIN}
      - FLASK_ENV=development
      - GEVENT_SUPPORT=True
      - MAIL_DEFAULT_SENDER=${MAIL_DEFAULT_SENDER}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_SERVER=${MAIL_SERVER}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MONKEY_PATCHING=True
      - NO_SSL=${NO_SSL}
      - POSTGRESQL_DB_HOST=${POSTGRESQL_DB_HOST}
      - POSTGRESQL_DB_NAME=${POSTGRESQL_DB_NAME}
      - POSTGRESQL_DB_PASSWORD=${POSTGRESQL_DB_PASSWORD}
      - POSTGRESQL_DB_PORT=${POSTGRESQL_DB_PORT}
      - POSTGRESQL_DB_USER=${POSTGRESQL_DB_USER}
      - PYTHONUNBUFFERED=1
      - SUPER_PASSWORD=${SUPER_PASSWORD}
      - SUPER_USER=${SUPER_USER}
      - SUPER_USER_FIRSTNAME=${SUPER_USER_FIRSTNAME}
      - SUPER_USER_LASTNAME=${SUPER_USER_LASTNAME}
      - SUPER_USER_ORG=${SUPER_USER_ORG}
      - SUPPORT_AD_AUTHENTICATION=${SUPPORT_AD_AUTHENTICATION}
      - VERBOSE=${VERBOSE}
      - WAIT_COMMAND=[ $$(curl --write-out %{http_code} --silent --output /dev/null http://elasticsearch:9200/_cat/health?h=st) = 200 ]
      - WAIT_LOOPS=30
      - WAIT_SLEEP=10
      - ENFORCE_SECURE_COOKIE=${ENFORCE_SECURE_COOKIE}
      - api_key=${api_key}
      - BOOTSTRAP_TASKS=True  # Bootstrap tasks now runs in req-router after workspaces are created

  conv-mgr:
    image: ${DK_CONV_MGR_IMAGE:-public.ecr.aws/n5k3t9x2/conv_mgr}:${DK_CONV_MGR_TAG:-latest}
    networks:
      - saaslocalnetwork
    depends_on:
      settings:
        condition: service_started
      ansi-processing:
        condition: service_started
    environment:
      - DAGKNOWS_WSFE_URL=${DAGKNOWS_WSFE_URL}
      - DAGKNOWS_ELASTIC_URL=${DAGKNOWS_ELASTIC_URL}
      - DAGKNOWS_URL=${DAGKNOWS_URL}
      - GEVENT_SUPPORT=True
      - PYTHONUNBUFFERED=1

  apigateway:
    image: ${DK_APIGATEWAY_IMAGE:-public.ecr.aws/n5k3t9x2/apigateway}:${DK_APIGATEWAY_TAG:-latest}
    networks:
      - saaslocalnetwork
    depends_on:
      req-router:
        condition: service_started
    environment:
      - DAGKNOWS_ELASTIC_URL=${DAGKNOWS_ELASTIC_URL}
      - DagKnowsReqRouterHost=${DAGKNOWS_URL}
    restart: on-failure

  ansi-processing:
    image: ${DK_ANSI_PROCESSING_IMAGE:-public.ecr.aws/n5k3t9x2/ansi_processing}:${DK_ANSI_PROCESSING_TAG:-latest}
    networks:
      - saaslocalnetwork

  settings:
    image: ${DK_SETTINGS_IMAGE:-public.ecr.aws/n5k3t9x2/settings}:${DK_SETTINGS_TAG:-latest}
    networks:
      - saaslocalnetwork
    depends_on:
      taskservice:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:2225/health', timeout=3).read()\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s
    environment:
      - MONKEY_PATCHING=True
      - DAGKNOWS_ELASTIC_URL=${DAGKNOWS_ELASTIC_URL}
      - FLASK_ENV=development
      - SUPER_USER_ORG=${SUPER_USER_ORG}
      - DAGKNOWS_URL=${DAGKNOWS_URL}
      - COMMUNITY_URL=${COMMUNITY_URL}
      - COMMUNITY=${COMMUNITY}
      - PYTHONUNBUFFERED=1
      - GEVENT_SUPPORT=True
    command: ["python", "src/settings.py"]
  wsfe:
    image: ${DK_WSFE_IMAGE:-public.ecr.aws/n5k3t9x2/wsfe}:${DK_WSFE_TAG:-latest}
    restart: unless-stopped
    networks:
      - saaslocalnetwork
    environment:
      - APP_SECRET_KEY=${APP_SECRET_KEY}
      - POSTGRESQL_DB_USER=${POSTGRESQL_DB_USER}
      - POSTGRESQL_DB_PASSWORD=${POSTGRESQL_DB_PASSWORD}
      - POSTGRESQL_DB_HOST=${POSTGRESQL_DB_HOST}
      - POSTGRESQL_DB_PORT=${POSTGRESQL_DB_PORT}
      - POSTGRESQL_DB_NAME=${POSTGRESQL_DB_NAME}

  jobsched:
    image: ${DK_JOBSCHED_IMAGE:-public.ecr.aws/n5k3t9x2/jobsched}:${DK_JOBSCHED_TAG:-latest}
    networks:
      - saaslocalnetwork
    depends_on:
      taskservice:
        condition: service_healthy
      settings:
        condition: service_healthy
    environment:
      - DAGKNOWS_ELASTIC_URL=${DAGKNOWS_ELASTIC_URL}
      - POSTGRESQL_DB_USER=${POSTGRESQL_DB_USER}
      - POSTGRESQL_DB_PASSWORD=${POSTGRESQL_DB_PASSWORD}
      - POSTGRESQL_DB_HOST=${POSTGRESQL_DB_HOST}
      - POSTGRESQL_DB_PORT=${POSTGRESQL_DB_PORT}
      - POSTGRESQL_DB_NAME=${POSTGRESQL_DB_NAME}


  taskservice:
    image: ${DK_TASKSERVICE_IMAGE:-public.ecr.aws/n5k3t9x2/taskservice}:${DK_TASKSERVICE_TAG:-latest}
    networks:
      - saaslocalnetwork
    command: ["python", "src/gateway.py"]
    depends_on:
      wsfe:
        condition: service_started
    environment:
      - ALLOW_DK_USER_INFO_HEADER=true
      - COMMUNITY_URL=${COMMUNITY_URL}
      - COMMUNITY=${COMMUNITY}
      - DAGKNOWS_ELASTIC_URL=${DAGKNOWS_ELASTIC_URL}
      - DAGKNOWS_PROXY_URL=http://wsfe:4446/proxies
      - DAGKNOWS_FORCE_TOKEN=${DAGKNOWS_FORCE_TOKEN}
      - DAGKNOWS_WSFE_URL=${DAGKNOWS_WSFE_URL}
      - DEFAULT_ORG=${DEFAULT_ORG}
      - ENFORCE_LOGIN=${ENFORCE_LOGIN}
      - FLASK_ENV=development
      - GEVENT_SUPPORT=True
      - MONKEY_PATCHING=True
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_ORG_ID=${OPENAI_ORG_ID}
      - POSTGRESQL_DB_HOST=${POSTGRESQL_DB_HOST}
      - POSTGRESQL_DB_NAME=${POSTGRESQL_DB_NAME}
      - POSTGRESQL_DB_PASSWORD=${POSTGRESQL_DB_PASSWORD}
      - POSTGRESQL_DB_PORT=${POSTGRESQL_DB_PORT}
      - POSTGRESQL_DB_USER=${POSTGRESQL_DB_USER}
      - PYTHONUNBUFFERED=1
      - SUPER_USER_ORG=${SUPER_USER_ORG}
      # Note: BOOTSTRAP_TASKS has been moved to req-router service
    healthcheck:
      # Use Python to check health endpoint (Python is always available in the container)
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:2235/health', timeout=3).read()\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  nginx:
    image: nginx:latest
    networks:
      - saaslocalnetwork
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./sample-selfsigned.key:/root/ssl/server.key
      - ./sample-selfsigned.crt:/root/ssl/server.crt
    depends_on:
      - req-router
      - dagknows-nuxt
      - wsfe
    ports:
      - 80:80
      - 443:443

  dagknows-nuxt:
    image: ${DK_DAGKNOWS_NUXT_IMAGE:-public.ecr.aws/n5k3t9x2/dagknows_nuxt}:${DK_DAGKNOWS_NUXT_TAG:-latest}
    networks:
      - saaslocalnetwork
    command: node .output/server/index.mjs
    environment:
      - DAGKNOWS_ELASTIC_URL=${DAGKNOWS_ELASTIC_URL}
      - ALLOW_DK_USER_INFO_HEADER=true
      - DEFAULT_ORG=${DEFAULT_ORG}
      - SUPER_USER_ORG=${SUPER_USER_ORG}
      - NITRO_PRESET=${NITRO_PRESET}
      - NITRO_HOST=0.0.0.0
      - NITRO_PORT=3000
      - COMMUNITY_URL=${COMMUNITY_URL}
      - COMMUNITY=${COMMUNITY}
      - DOWNLOAD_TASK_ID=${DOWNLOAD_TASK_ID}
      - ENFORCE_LOGIN=${ENFORCE_LOGIN}
      - NUXT_PUBLIC_GTAG_ID=${NUXT_PUBLIC_GTAG_ID}
      - ENABLE_WEBSOCKETS=${ENABLE_WEBSOCKETS}
    depends_on:
      - req-router
